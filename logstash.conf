input {
  jdbc { 
    jdbc_connection_string => "jdbc:mysql://mysqlgrotto/grottoce"
    # The user we wish to execute our statement as
    jdbc_user => "sailsuser"
    jdbc_password => "grottocepassword"
    # The path to our downloaded jdbc driver
    jdbc_driver_library => "/config-dir/mysql-connector-java-5.1.47/mysql-connector-java-5.1.47-bin.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    # our query
    statement => "
      SELECT 
        entry.*, 
        GROUP_CONCAT(description.Title, description.Body) as 'descriptions',
        
        GROUP_CONCAT(cave.Name) as 'caves',
        
        # Don't worry about the next 2 lines : currently they will be only one cave for an entry and thus, one length and depth
        GROUP_CONCAT(cave.length) as 'cave length',
        GROUP_CONCAT(cave.depth) as 'cave depth',
        
        GROUP_CONCAT(rigging.Title, rigging.Observations, rigging.Obstacles) as 'riggings',
        GROUP_CONCAT(location.Body) as 'location',
        GROUP_CONCAT(bibliography.Body) as 'bibliography'
      FROM t_entry entry

      LEFT JOIN t_cave cave ON cave.id = entry.Id_cave

      LEFT JOIN j_entry_description jed ON jed.id_entry = entry.id
      LEFT JOIN t_description description ON description.id = jed.id_description

      LEFT JOIN j_entry_rigging jer ON jer.id_entry = entry.id
      LEFT JOIN t_rigging rigging ON rigging.id = jer.id_rigging

      LEFT JOIN t_location location ON location.id_entry = entry.id
      
      LEFT JOIN t_bibliography bibliography ON bibliography.id_entry = entry.id

      GROUP BY entry.id
    "
    # Launch query every monday at 3:00 (night)
    # schedule => "0 3 * * mon"
    type => "entry"
  }

  jdbc { 
    jdbc_connection_string => "jdbc:mysql://mysqlgrotto/grottoce"
    # The user we wish to execute our statement as
    jdbc_user => "sailsuser"
    jdbc_password => "grottocepassword"
    # The path to our downloaded jdbc driver
    jdbc_driver_library => "/config-dir/mysql-connector-java-5.1.47/mysql-connector-java-5.1.47-bin.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    # our query
    statement => "
      SELECT 
        massif.*, 
        GROUP_CONCAT(
            entry.name
            SEPARATOR ', '
        ) as 'entries names',
        GROUP_CONCAT(
          DISTINCT entry.city
          SEPARATOR ', '
        ) as 'entries cities',
        GROUP_CONCAT(
          DISTINCT entry.county
          SEPARATOR ', '
        ) as 'entries counties',
        GROUP_CONCAT(
          DISTINCT entry.country
          SEPARATOR ', '
        ) as 'entries countries',
        GROUP_CONCAT(
          DISTINCT entry.city
          SEPARATOR ', '
        ) as 'entries cities',
        GROUP_CONCAT(
          DISTINCT entry.region
          SEPARATOR ', '
        ) as 'entries regions'
      FROM t_massif massif
      LEFT JOIN j_massif_cave jmc ON jmc.id_massif = massif.id
      LEFT JOIN t_entry entry ON entry.id = jmc.id_entry
      GROUP BY massif.id
    "
    # Launch query every monday at 3:00 (night)
    # schedule => "0 3 * * mon"
    type => "massif"
  }

  jdbc { 
    jdbc_connection_string => "jdbc:mysql://mysqlgrotto/grottoce"
    # The user we wish to execute our statement as
    jdbc_user => "sailsuser"
    jdbc_password => "grottocepassword"
    # The path to our downloaded jdbc driver
    jdbc_driver_library => "/config-dir/mysql-connector-java-5.1.47/mysql-connector-java-5.1.47-bin.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    # our query
    statement => "
      SELECT 
        grotto.*,
        GROUP_CONCAT(caver.Nickname) as 'members'
      FROM t_grotto grotto
      LEFT JOIN j_grotto_caver jgc ON jgc.id_grotto = grotto.id
      LEFT JOIN t_caver caver ON caver.id = jgc.id_caver
      GROUP BY grotto.id
    "
    # Launch query every monday at 3:00 (night)
    # schedule => "0 3 * * mon"
    type => "grotto"
  }
}
output {
  # debugging purpose
  # stdout { codec => json_lines }
  if [type] == "entry" {
    elasticsearch {
      hosts => "elasticsearchgrotto:9200"
      index => "entries-index"
      document_type => "data"
      action => "update"
      document_id => "%{id}"
      doc_as_upsert => true
    }
  }

  if [type] == "massif" {
    elasticsearch {
      hosts => "elasticsearchgrotto:9200"
      index => "massifs-index"
      document_type => "data"
      action => "update"
      document_id => "%{id}"
      doc_as_upsert => true
    }
  }

  if [type] == "grotto" {
    elasticsearch {
      hosts => "elasticsearchgrotto:9200"
      index => "grottos-index"
      document_type => "data"
      action => "update"
      document_id => "%{id}"
      doc_as_upsert => true
    }
  }
}